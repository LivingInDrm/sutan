# 检定机制

本文档定义骰子检定的完整规则。枚举值参考 [../data/enums.md](../data/enums.md)。

## 基础检定流程

```
[计算检定池] → [投掷骰子] → [爆骰处理] → [重投] → [金骰子] → [判定结果]
```

---

## 检定池计算

检定池的计算方式由场景脚本定义，支持多种模式：

| 计算模式 | key | 说明 | 适用场景 |
|----------|-----|------|----------|
| 最大值 | `max` | 取所有投入角色中该属性的最大值 | 英雄场景，由最强者决定成败 |
| 求和 | `sum` | 所有投入角色的属性值相加 | 团队协作，人多力量大 |
| 最小值 | `min` | 取所有投入角色中该属性的最小值 | 木桶效应，受最弱者拖累 |
| 平均值 | `avg` | 所有投入角色的属性平均值（向下取整） | 平衡考量 |
| 首位 | `first` | 仅取第一个必选卡槽角色的属性 | 单人挑战 |
| 指定 | `specific` | 仅取特定卡槽角色的属性 | 指定角色检定 |

### 配置示例

```json
{
  "check": {
    "attribute": "combat",
    "calc_mode": "max",
    "target": 8
  }
}
```

### 场景示例

- 场景"沙漠穿越"配置 `calc_mode: "min"`，生存属性取最低 → 队伍中最弱的人拖后腿
- 场景"攻城战"配置 `calc_mode: "sum"`，战斗属性求和 → 鼓励投入多个战士
- 场景"单挑决斗"配置 `calc_mode: "first"`，仅第一个角色 → 只能派一人应战

---

## 装备和卡片加成

```
最终检定池 = 基础属性值（按calc_mode计算） + 装备加成 + 临时卡片加成
```

- **装备加成**：仅计算参与检定的角色所装备的卡片加成
- **临时加成**：情报卡、消耗品等提供的一次性加成
- **加成叠加**：同类加成可叠加，无上限

---

## 骰子规则

| 参数 | 值 | 说明 |
|------|-----|------|
| 骰子类型 | D10 | 十面骰，1-10 |
| 投掷数量 | `min(检定池, 20)` | 超出20的部分直接忽略 |
| 成功判定 | ≥7 | 单颗骰子 ≥ 7 即为1个成功 |
| 爆骰触发 | =10 | 骰出10时，额外再投1颗骰子 |
| 爆骰连锁 | 允许 | 额外骰继续出10可连锁爆骰 |
| 爆骰上限 | 20 | 额外骰总数上限（避免无限循环） |

---

## 重投机制

- **重投次数来源**：角色 `special_attributes.reroll` + 装备加成 + 消耗品加成
- **语义**：`reroll` 表示本次检定中玩家最多可选择 X 颗失败骰进行重投
- **使用时机**：看到初投+爆骰结果后，选择任意数量的失败骰（≤ reroll总数）重投
- **重投限制**：每颗骰子最多被重投1次
- **操作**：玩家一次性选定要重投的失败骰，掷骰后结果立即生效

---

## 金骰子

- **获取方式**：稀有奖励、成就解锁、特定事件
- **使用效果**：消耗1枚金骰子，直接增加1个成功数
- **使用时机**：重投结束后、确认结果前
- **使用上限**：无上限（由资源稀缺性控制）

---

## 检定操作顺序

1. **初投**：掷 dice_count 颗骰子
2. **爆骰处理**：10连锁产生额外骰，直到无10或达上限
3. **可选：重投**：选择失败骰重投，每骰最多1次
4. **可选：金骰子**：消耗金骰子增加成功数
5. **确认**：锁定最终成功数，进入结果分支

---

## 检定结果判定

| 条件 | 结果key | 说明 |
|------|---------|------|
| `success_count >= target` | `success` | 完全成功，获得正面奖励 |
| `target - 2 <= success_count < target` | `partial_success` | 险胜，获得部分奖励，可能有代价 |
| `1 <= success_count < target - 2` | `failure` | 失败，获得惩罚或无奖励 |
| `success_count == 0` | `critical_failure` | 大失败，严重惩罚 |

**注意**：
- `target` 最小值为1
- 当 `target <= 2` 时，`partial_success` 区间不存在，直接判定 `success` 或 `failure`

---

## 概率参考

D10 单颗骰子成功率（≥7）：40%

| 检定池 | 期望成功数 | 0成功概率 | ≥1成功概率 |
|--------|-----------|----------|-----------|
| 5 | 2 | 7.8% | 92.2% |
| 8 | 3.2 | 1.7% | 98.3% |
| 10 | 4 | 0.6% | 99.4% |
| 15 | 6 | 0.05% | 99.95% |
| 20 | 8 | 0.004% | 99.996% |

（不含爆骰加成）

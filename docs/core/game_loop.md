# 核心游戏循环

本文档定义游戏的整体流程、每日循环、胜负条件。

## 整体流程

```
[游戏开始] → [每日循环] × N天 → [游戏结束（胜利/失败）]
```

---

## 游戏目标

### 胜利条件

1. **主线胜利**：完成特定剧情成就（如"苏丹的戒指"），触发游戏通关
2. **生存胜利**：在处刑日倒计时归零前，成功脱手所有苏丹卡
3. **隐藏结局**：满足特定隐藏条件触发的特殊结局

### 失败条件

1. **处刑失败**：处刑日倒计时归零时，手牌区仍持有苏丹卡 → 被苏丹处决
2. **死亡失败**：主角人物卡在事件中死亡

---

## 每日循环详细流程

```
┌─────────────────────────────────────────────────────────┐
│                    【黎明阶段】                          │
│  1. 显示当日事件通知                                     │
│  2. 刷新可用场景（新场景出现/旧场景消失）                  │
│  3. 处刑日倒计时 -1                                      │
│  4. 每7天触发：商店刷新、卡牌更换机会                      │
│  5. 重置俺寻思次数（think_charges = 3）                   │
│  6. 清空今日已思考卡牌列表（think_used_today = []）        │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    【行动阶段】                          │
│  玩家自由行动，可进行以下操作（不限顺序，可重复）：        │
│                                                         │
│  [场景参与] 选择地图上的场景 → 投入所需卡片 → 锁定参与     │
│  [卡牌管理] 整理手牌、装备/卸下装备、查看卡牌详情          │
│  [俺寻思]   将卡牌置入思考槽 → 触发该卡牌的思考事件        │
│  [商店购物] 进入商店场景购买物品                          │
│  [信息查看] 查看声望、成就、角色关系等                    │
│                                                         │
│  ★ 可同时参与多个场景（只要有足够的卡片投入）             │
│  ★ 已投入场景的卡片在结算前不可使用                       │
│  ★ 无行动点限制，仅受卡牌资源限制                         │
└─────────────────────────────────────────────────────────┘
                           ↓
                    [玩家点击"下一天"]
                           ↓
┌─────────────────────────────────────────────────────────┐
│                    【结算阶段】                          │
│  玩家点击"下一天"后，所有 active 场景 remaining_turns -1 │
│                                                         │
│  [回合数 > 0 的场景]                                     │
│    → 继续等待，投入的卡片保持锁定                         │
│                                                         │
│  [回合数 = 0 的场景]（本日结算）                          │
│    → 执行检定（若有）                                    │
│    → 根据结果分支（success/partial_success/failure/      │
│      critical_failure）应用 effects                      │
│    → 归还投入的卡片（除非被消耗/移除）                    │
│    → 场景从地图上移除或重置                              │
│                                                         │
│  [未参与但到期的场景]                                    │
│    → 若有 absence_penalty 则执行，否则直接消失            │
└─────────────────────────────────────────────────────────┘
                           ↓
                    [检查胜利/失败条件]
                           ↓
              [未结束] → 返回黎明阶段，开始新的一天
              [已结束] → 显示结局画面
```

---

## 时间推进规则

- **1天 = 1回合**：玩家点击"下一天"后，所有 active 场景的 `remaining_turns -= 1`
- **结算触发**：当场景 `remaining_turns` 从 1 变为 0 时，当天进入该场景结算流程
- **无行动点**：行动阶段内玩家可自由操作，不消耗行动点，仅受卡牌资源限制

---

## 苏丹卡与处刑日

### 苏丹卡

- **获取方式**：特定事件强制获得、某些奖励附带
- **持有风险**：处刑日归零时持有 = 游戏失败
- **脱手方式**：
  1. 完成特定任务/事件
  2. 转交给其他NPC（需满足条件）
  3. 通过特殊场景销毁（可能有代价）
  4. 作为某些事件的投入品消耗掉

### 处刑日倒计时

- **初始值**：根据难度设定（简单21天/普通14天/困难7天）
- **每日递减**：黎明阶段自动 -1
- **延长方式**：特定事件奖励、消耗稀有资源
- **归零效果**：检查手牌中的苏丹卡数量
  - 0张：安全，游戏继续（重置倒计时或进入新章节）
  - ≥1张：处刑结局，游戏失败

---

## 时间回溯

### 回溯次数

- **初始次数**：3次
- **获取方式**：稀有成就奖励、特定事件
- **消耗**：每次回溯消耗1次

### 回溯规则

- **回溯范围**：只能回到上一天的黎明阶段
- **保留内容**：玩家记忆（元信息）、已解锁的成就
- **重置内容**：当天的所有行动、场景状态、卡片位置
- **不可回溯**：游戏失败后不可回溯（除非有特殊道具）

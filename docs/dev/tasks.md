# 开发任务列表

本文档定义苏丹游戏的开发任务分解，任务按依赖层级组织，每个任务独立可测试。

---

## 开发进度

| 层级 | 状态 | 完成日期 | 备注 |
|------|------|----------|------|
| 第一层：基础设施 | TODO | - | - |
| 第二层：数据层 | TODO | - | - |
| 第三层：检定系统 | TODO | - | - |
| 第四层：卡牌管理 | TODO | - | - |
| 第五层：场景系统 | TODO | - | - |
| 第六层：结算系统 | TODO | - | - |
| 第七层：游戏流程 | TODO | - | - |
| 第八层：游戏主控 | TODO | - | - |
| 第九层：状态管理 | TODO | - | - |
| 第十层：UI组件 | TODO | - | - |
| 第十一层：界面屏幕 | TODO | - | - |
| 第十二层：Electron集成 | TODO | - | - |
| 第十三层：内容配置 | TODO | - | - |

---

## 第一层：基础设施

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T1.1 | 枚举定义 | TypeScript 枚举常量（稀有度、属性、卡牌类型、场景类型等） | `data/enums.md` | 无 |
| T1.2 | 类型定义 | 核心 TypeScript 接口（Card, Scene, GameState, Effects 等） | `data/schema.md`, `data/enums.md` | T1.1 |
| T1.3 | Zod Schema | 数据校验 schema（卡牌、场景、存档） | `data/schema.md` | T1.1, T1.2 |
| T1.4 | 随机数封装 | seedrandom 封装，支持种子存储和回溯 | `dev/architecture.md` | 无 |
| T1.5 | 事件总线 | mitt 实例封装 | `dev/architecture.md` | 无 |

### 测试要点

- T1.1: 枚举值完整性、key 唯一性
- T1.2: 接口字段与 schema.md 一致
- T1.3: 校验合法/非法 JSON、错误信息清晰
- T1.4: 相同种子输出一致、种子可序列化
- T1.5: 发布/订阅正确触发、取消订阅有效

---

## 第二层：数据层

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T2.1 | 数据加载器 | JSON 配置加载、Zod 校验、缓存 | `dev/architecture.md` | T1.3 |
| T2.2 | 玩家状态 | PlayerState 类：金币、声望、金骰子、回溯次数、俺寻思次数 | `data/schema.md` (game_state), `data/balance.md` | T1.2 |
| T2.3 | 卡牌数据模型 | 卡牌实例化、属性访问、标签操作 | `data/schema.md` (卡牌结构), `content/cards.md` | T1.2, T1.3 |

### 测试要点

- T2.1: 加载成功/失败、缓存命中、校验错误抛出
- T2.2: 资源增减、边界检查（声望0-100）、初始值正确
- T2.3: 属性总和计算、标签增删、类型判断

---

## 第三层：检定系统

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T3.1 | 检定池计算 | calc_mode 实现：max/sum/min/avg/first/specific | `core/dice_check.md` (检定池计算) | T1.1, T2.3 |
| T3.2 | 骰子检定器 | DiceChecker：投骰、爆骰连锁、成功判定 | `core/dice_check.md` (骰子规则, 爆骰) | T1.4, T3.1 |
| T3.3 | 重投系统 | 重投选择逻辑、每骰最多一次限制 | `core/dice_check.md` (重投机制) | T3.2 |
| T3.4 | 金骰子系统 | 消耗金骰子增加成功数 | `core/dice_check.md` (金骰子) | T2.2, T3.3 |
| T3.5 | 检定结果判定 | success/partial_success/failure/critical_failure | `core/dice_check.md` (检定结果判定), `data/enums.md` (check_result) | T3.4 |

### 测试要点

- T3.1: 各模式计算正确（max/sum/min/avg/first）
- T3.2: 爆骰连锁触发、爆骰上限(20)、成功阈值(≥7)
- T3.3: 重投次数消耗、每骰仅能重投一次
- T3.4: 金骰子消耗、成功数+1
- T3.5: 各结果区间判定正确、target≤2时无partial_success

---

## 第四层：卡牌管理

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T4.1 | 卡牌管理器 | CardManager：增删查、手牌列表、上限检查(512) | `content/cards.md` (卡牌管理规则) | T2.3 |
| T4.2 | 装备系统 | EquipmentSystem：装备穿脱、槽位限制、属性加成计算 | `content/cards.md` (装备卡), `data/schema.md` (装备卡额外字段) | T4.1 |
| T4.3 | 卡牌标签系统 | 标签增删、标签查询 | `content/cards.md` (标签系统) | T4.1 |

### 测试要点

- T4.1: CRUD 操作、手牌上限(512)、主角卡不可删除
- T4.2: 装备槽数量限制、加成叠加计算、穿脱状态同步
- T4.3: 标签增删、按标签查询卡牌

---

## 第五层：场景系统

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T5.1 | 卡槽系统 | SlotSystem：卡牌投入、类型校验、锁定/解锁 | `data/schema.md` (卡槽字段), `data/enums.md` (slot_type) | T4.1 |
| T5.2 | 场景管理器 | SceneManager：场景池、解锁条件检查、状态流转 | `content/scenes.md`, `data/enums.md` (scene_status) | T5.1, T2.2 |
| T5.3 | 场景参与 | 参与场景、投入卡牌、锁定卡牌 | `core/game_loop.md` (行动阶段), `content/scenes.md` | T5.1, T5.2 |

### 测试要点

- T5.1: 卡槽类型校验、必填/可选、锁定状态
- T5.2: 解锁条件（声望、标签）、状态流转(available→participated→settling→completed)
- T5.3: 投入卡牌锁定、已锁定卡牌不可再用

---

## 第六层：结算系统

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T6.1 | 效果应用器 | EffectApplier：应用 effects（资源、卡牌、标签、解锁） | `core/settlement.md` (effects 字段详解), `data/schema.md` (effects) | T2.2, T4.1, T4.3 |
| T6.2 | 检定结算 | dice_check 类型结算流程 | `core/settlement.md` (检定结算) | T3.5, T6.1 |
| T6.3 | 交易结算 | trade 类型结算流程 | `core/settlement.md` (交易结算), `data/schema.md` (商店场景) | T6.1 |
| T6.4 | 选择结算 | choice 类型结算流程 | `core/settlement.md` (选择结算) | T6.1 |
| T6.5 | 结算执行器 | SettlementExecutor：统一调度三种结算类型 | `core/settlement.md` (结算原子性顺序) | T6.2, T6.3, T6.4 |
| T6.6 | 缺席处理 | absence_penalty 应用逻辑 | `core/settlement.md` (缺席处理规则), `data/schema.md` (absence_penalty) | T6.1 |

### 测试要点

- T6.1: 资源变化正负、卡牌增删、标签变更、card_invested_N 解析
- T6.2: 检定→结果分支→effects 完整流程
- T6.3: 购买/出售、库存变化
- T6.4: 选项选择→对应 effects
- T6.5: 三种结算类型正确调度、原子性保证
- T6.6: 有/无 absence_penalty 场景处理

---

## 第七层：游戏流程

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T7.1 | 时间管理器 | TimeManager：处刑日倒计时、回溯功能 | `core/game_loop.md` (处刑日倒计时, 时间回溯) | T2.2, T1.4 |
| T7.2 | 黎明阶段 | 场景刷新、倒计时-1、俺寻思重置 | `core/game_loop.md` (黎明阶段) | T5.2, T7.1, T7.4 |
| T7.3 | 结算阶段 | 批量结算到期场景、归还卡牌 | `core/game_loop.md` (结算阶段) | T6.5, T6.6 |
| T7.4 | 俺寻思系统 | ThinkSystem：次数管理、每日重置、已用列表 | `content/features.md`, `core/game_loop.md` (重置俺寻思) | T2.2, T4.1 |
| T7.5 | 每日管理器 | DayManager：黎明→行动→结算循环 | `core/game_loop.md` (每日循环详细流程) | T7.2, T7.3 |
| T7.6 | 胜负判定 | 苏丹卡检查、主线完成、死亡检测 | `core/game_loop.md` (胜利条件, 失败条件) | T4.1, T7.1 |

### 测试要点

- T7.1: 倒计时递减、回溯恢复状态、回溯次数消耗
- T7.2: 各黎明事件触发顺序
- T7.3: 到期场景批量结算、remaining_turns 递减
- T7.4: 次数消耗(3次/天)、每日重置、同卡每日仅一次
- T7.5: 阶段流转正确
- T7.6: 处刑失败/生存胜利/主线胜利判定

---

## 第八层：游戏主控

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T8.1 | GameManager | 游戏初始化、新游戏、加载存档、状态协调 | `dev/architecture.md` (Core Layer) | T7.5, T7.6 |

### 测试要点

- T8.1: 新游戏初始化、存档加载恢复、各子系统协调

---

## 第九层：状态管理

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T9.1 | gameStore | Zustand 游戏状态、actions 封装 | `dev/architecture.md` (Stores, 层间通信) | T8.1 |
| T9.2 | 存档中间件 | Zustand persist、序列化/反序列化 | `dev/architecture.md` (存档), `data/schema.md` (存档数据结构) | T9.1 |
| T9.3 | uiStore | UI 状态：当前界面、模态框、动画队列 | `dev/architecture.md` (Stores) | 无 |

### 测试要点

- T9.1: action 触发状态更新、订阅回调
- T9.2: 存档/读档数据完整性、版本兼容
- T9.3: 界面切换、模态框开关、动画队列先进先出

---

## 第十层：UI 组件

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T10.1 | 卡牌组件 | Card 渲染、稀有度样式、各类型卡牌 | `content/cards.md`, `ui/visual_style.md` | T9.1 |
| T10.2 | 卡槽组件 | Slot 渲染、拖放目标、必填/锁定状态 | `ui/layout.md`, `data/schema.md` (卡槽字段) | T9.1, T10.1 |
| T10.3 | 骰子组件 | 骰子 3D/2D 动画、爆骰效果、结果展示 | `ui/layout.md`, `core/dice_check.md` | T9.3 |
| T10.4 | 资源栏组件 | 金币、声望、倒计时、金骰子显示 | `ui/layout.md` | T9.1 |
| T10.5 | 拖放系统 | @dnd-kit 封装、卡牌拖放交互 | `dev/architecture.md` (拖放) | T10.1, T10.2 |

### 测试要点

- T10.1: 各稀有度样式、各类型卡牌布局
- T10.2: 拖入/拖出视觉反馈、必填红色标识
- T10.3: GSAP 动画播放、爆骰特效
- T10.4: 数值实时更新
- T10.5: 拖放交互、合法性校验反馈

---

## 第十一层：界面屏幕

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T11.1 | MapScreen | 大地图、场景节点、时间罗盘、路径 | `ui/layout.md` (地图界面) | T10.4, T9.1 |
| T11.2 | SceneScreen | 场景界面：左侧场景+卡槽，右侧对话 | `ui/layout.md` (场景界面), `content/scenes.md` | T10.1, T10.2, T10.5 |
| T11.3 | SettlementScreen | 结算界面：检定交互、重投选择、结果展示 | `ui/layout.md` (结算界面), `core/settlement.md` (结算UI) | T10.3, T10.1 |
| T11.4 | DialogScreen | 对话界面：选项列表、立绘、叙事文本 | `ui/layout.md` (对话界面) | T10.1, T9.1 |
| T11.5 | 商店界面 | 商店交易：购买/出售、库存展示 | `ui/layout.md`, `data/schema.md` (商店场景) | T10.1, T9.1 |

### 测试要点

- T11.1: 节点点击、路径显示、罗盘倒计时
- T11.2: 卡牌投入交互、对话推进
- T11.3: 重投选择、金骰子使用、结果动画
- T11.4: 选项选择、立绘切换
- T11.5: 购买/出售流程

---

## 第十二层：Electron 集成

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T12.1 | 主进程 | Electron 窗口管理、应用生命周期 | `dev/architecture.md` (Electron 主进程) | 无 |
| T12.2 | IPC 通道 | 主进程/渲染进程通信 | `dev/architecture.md` (目录结构) | T12.1 |
| T12.3 | 存档 IO | electron-store / fs 文件读写 | `dev/architecture.md` (存档) | T12.2, T9.2 |

### 测试要点

- T12.1: 窗口创建/关闭、生命周期事件
- T12.2: IPC 双向通信
- T12.3: 文件读写成功、错误处理

---

## 第十三层：内容配置

| ID | 任务名称 | 描述 | 依赖文档 | 依赖任务 |
|----|----------|------|----------|----------|
| T13.1 | 卡牌配置 | 编写卡牌 JSON 数据 | `data/schema.md` (卡牌), `content/cards.md`, `data/balance.md` | T2.1 |
| T13.2 | 场景配置 | 编写场景 JSON 数据 | `data/schema.md` (场景), `content/scenes.md`, `data/balance.md` | T2.1 |
| T13.3 | 成就配置 | 编写成就数据 | `content/features.md` | T2.1 |

### 测试要点

- T13.1: JSON 格式正确、Zod 校验通过
- T13.2: JSON 格式正确、Zod 校验通过
- T13.3: 成就触发条件有效

---

## 依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 1: 基础设施                                                       │
│  T1.1 ──→ T1.2 ──→ T1.3                                                 │
│  T1.4 (独立)    T1.5 (独立)                                              │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 2: 数据层                                                         │
│  T2.1 (←T1.3)    T2.2 (←T1.2)    T2.3 (←T1.2,T1.3)                      │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 3: 检定系统                                                       │
│  T3.1 ──→ T3.2 ──→ T3.3 ──→ T3.4 ──→ T3.5                               │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 4: 卡牌管理                                                       │
│  T4.1 ──→ T4.2                                                          │
│       └──→ T4.3                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 5: 场景系统                                                       │
│  T5.1 ──→ T5.2 ──→ T5.3                                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 6: 结算系统                                                       │
│  T6.1 ──→ T6.2 ──┐                                                      │
│       ├──→ T6.3 ─┼──→ T6.5                                              │
│       └──→ T6.4 ─┘                                                      │
│  T6.6 (←T6.1)                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 7: 游戏流程                                                       │
│  T7.1 ──→ T7.2 ──┐                                                      │
│  T7.4 ──→        ├──→ T7.5 ──→ T7.6                                     │
│          T7.3 ───┘                                                      │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 8: 游戏主控                                                       │
│  T8.1                                                                   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 9: 状态管理                                                       │
│  T9.1 ──→ T9.2                                                          │
│  T9.3 (独立)                                                            │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 10: UI 组件                                                       │
│  T10.1 ──→ T10.2 ──→ T10.5                                              │
│  T10.3 (←T9.3)    T10.4                                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 11: 界面屏幕                                                      │
│  T11.1    T11.2    T11.3    T11.4    T11.5                              │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 12: Electron 集成                                                 │
│  T12.1 ──→ T12.2 ──→ T12.3                                              │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  Layer 13: 内容配置 (可并行)                                             │
│  T13.1    T13.2    T13.3                                                │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 推荐开发顺序

### 阶段一：核心逻辑（可纯单元测试）

```
T1.1 → T1.2 → T1.3 → T1.4 → T1.5
  ↓
T2.1 → T2.2 → T2.3
  ↓
T3.1 → T3.2 → T3.3 → T3.4 → T3.5
  ↓
T4.1 → T4.2 → T4.3
  ↓
T5.1 → T5.2 → T5.3
  ↓
T6.1 → T6.2/T6.3/T6.4 → T6.5 → T6.6
```

**产出**：完整的 Core Layer，100% 单元测试覆盖

### 阶段二：游戏流程（集成测试）

```
T7.1 → T7.2 → T7.3 → T7.4 → T7.5 → T7.6
  ↓
T8.1
```

**产出**：可运行的游戏逻辑，无 UI

### 阶段三：状态层（Mock UI 测试）

```
T9.1 → T9.2
T9.3
```

**产出**：Zustand Store，可对接 UI

### 阶段四：UI 层

```
T10.1 → T10.2 → T10.5
T10.3 → T10.4
  ↓
T11.1 → T11.2 → T11.3 → T11.4 → T11.5
```

**产出**：完整 React UI

### 阶段五：Electron 集成

```
T12.1 → T12.2 → T12.3
```

**产出**：桌面应用

### 并行任务：内容配置

```
T13.1, T13.2, T13.3 （可在阶段一完成后并行进行）
```

---

## 里程碑

| 里程碑 | 完成任务 | 验收标准 |
|--------|----------|----------|
| M1 核心逻辑 | T1-T6 | 所有 Core 单元测试通过 |
| M2 游戏流程 | T7-T8 | 命令行可运行完整游戏循环 |
| M3 状态管理 | T9 | Store 与 Core 集成测试通过 |
| M4 UI 完成 | T10-T11 | 浏览器可运行完整游戏 |
| M5 桌面应用 | T12 | Electron 打包成功 |
| M6 内容完整 | T13 | 首批卡牌/场景数据就绪 |
